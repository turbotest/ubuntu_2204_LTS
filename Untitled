# The install definition contains the commands needed to create a Ubuntu
# 22.04.3 LTS virtual machine capable of running your tests.
#
# This is where you install required programming languages, databases and other
# supporting libraries.
#
# The build installation is cached as a virtual machine image for subsequent
# check runs. When the install section changes, the virtual machine image is
# re-created.
#
# Installation commands are specified as a TOML multi-line string.
#
# N.B. Shell commands MUST execute non-interactively. For example, commands
# requiring user input will hang until the check run is cancelled or after a
# 15 minute timeout.
[setup]
packages = '''
# Install oxipng
wget https://github.com/shssoichiro/oxipng/releases/download/v8.0.0/oxipng-8.0.0-x86_64-unknown-linux-musl.tar.gz && \
tar -xzvf oxipng-8.0.0-x86_64-unknown-linux-musl.tar.gz && \
sudo cp oxipng-8.0.0-x86_64-unknown-linux-musl/oxipng /usr/local/bin && \
rm oxipng-8.0.0-x86_64-unknown-linux-musl.tar.gz && \
rm -Rf oxipng-8.0.0-x86_64-unknown-linux-musl

sudo systemctl enable postgres-16
sudo systemctl enable redis
sudo systemctl enable elasticsearch

# NodeJS
nvm alias default 18
nvm use 18
npm install -g npm@10.4.0 svgo yarn
yarn install --ignore-scripts

# Rails
bundle install --jobs 4 --retry 5
createdb discourse_test
createdb discourse_test_multisite
RAILS_ENV=test bundle exec rails db:migrate
'''

# The setup definition specifies commands to execute before running your test
# suites.
#
# Use the setup definition to update your project dependencies or compile classes.
# For example, in a ruby project here's where you run bundle install.
#
# Unlike the install definition, setup is not cached and therefore executes on
# every build.
test_suite = '''
bundle install --deployment --jobs 4 --retry 5
RAILS_ENV=test bundle exec rails db:migrate
'''

# Test suites are inferred from each TOML key ending with test_suite.
#
# Specify multiple test suites by adding test_suite keys. For example:
# [test_suite."system tests"]
# [test_suite.integration]
#
# Create a default test_suite if your build only requires one test suite.
[test_suite.default]

# A string specifying the command which executes one test file.
#
# The test file is passed as the last argument to the command.
command = "bin/rspec"

# An array of file path globs which expands to a list of files. File paths are
# relative to the project directory.
#
# Each file is passed as the last argument to your test command.
# Default test suite
# files = ["spec/**/*_spec.rb"]
files = ["spec/models/user_spec.rb"]

# An array of file path globs which expands to a list of files. File paths are
# relative to the project directory.
#
# No tests will be executed with any files matched in this definition section.
ignore = [
  "spec/models/IGNORE_spec.rb"
]